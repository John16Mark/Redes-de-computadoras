#include <stdio.h>

#define TAM_MAX_TRAMA 125
#define inicio 14
#define fin(IHL) 14+IHL // Omitimos el -1 porque en la funci√≥n de checksum ya se abarca todo el rango

void calcular(unsigned char T[]);
unsigned short int checksum(unsigned char T[], unsigned char begin, unsigned char end);

int main() {
    //unsigned char Trama[] = {0x52, 0x65, 0x64, 0x65, 0x73, 0x20, 0x64, 0x65, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x75, 0x74, 0x61, 0x64, 0x6f, 0x72, 0x61, 0x73, 0x2e};
    //unsigned char T[] = {'H', 'o', 'l', 'a'};
    //unsigned char T[] = {0xaa, 0xaa, 0xaa};
    /*unsigned char Trama1[] = {0x45, 0x00, //TIP
    0x00, 0x6f, 0x90, 0x30, 0x40, 0x00, 0xfb, 0x11, 0x24, 0xe7, 0x94, 0xcc, 0x67, 0x02, 0x94, 0xcc, 
    0x39, 0xcb};
    unsigned char Trama2[] = {0x45, 0x00, //TIP
    0x00, 0x3c, 0x04, 0x57, 0x00, 0x00, 0x80, 0x00, 0x98, 0x25, 0x94, 0xcc, 0x39, 0xcb, 0x94, 0xcc, 
    0x3a, 0xe1};
    unsigned char Trama3[] = {0x45, 0x00, //T11
    0x00, 0x30, 0x2c, 0x00, 0x40, 0x00, 0x80, 0x06, 0x4b, 0x74, 0xc0, 0xa8, 0x01, 0x02, 0xc0, 0xa8, 
    0x01, 0x01};*/

    unsigned char T[][TAM_MAX_TRAMA]={
    {
    0x00, 0x23, 0x8b, 0x46, 0xe9, 0xad, 0x00, 0x1f, 0x45, 0x9d, 0x1e, 0xa2, 0x08, 0x00, 0x45, 0x00, //TIP
    0x00, 0x6f, 0x90, 0x30, 0x40, 0x00, 0xfb, 0x11, 0x00, 0x00, 0x94, 0xcc, 0x67, 0x02, 0x94, 0xcc, 
    0x39, 0xcb, 0x00, 0x35, 0x04, 0x0c, 0x00, 0x5b, 0xe8, 0x60, 0xe2, 0x1a, 0x85, 0x80, 0x00, 0x01, 
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x03, 0x77, 0x77, 0x77, 0x03, 0x69, 0x73, 0x63, 0x05, 0x65, 
    0x73, 0x63, 0x6f, 0x6d, 0x03, 0x69, 0x70, 0x6e, 0x02, 0x6d, 0x78, 0x00, 0x00, 0x1c, 0x00, 0x01, 
    0xc0, 0x14, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x0e, 0x10, 0x00, 0x21, 0x04, 0x64, 0x6e, 0x73, 
    0x31, 0xc0, 0x1a, 0x03, 0x74, 0x69, 0x63, 0xc0, 0x1a, 0x77, 0xec, 0xdf, 0x29, 0x00, 0x00, 0x2a, 
    0x30, 0x00, 0x00, 0x0e, 0x10, 0x00, 0x12, 0x75, 0x00, 0x00, 0x00, 0x2a, 0x30},
    {
    0x00, 0x1f, 0x45, 0x9d, 0x1e, 0xa2, 0x00, 0x23, 0x8b, 0x46, 0xe9, 0xad, 0x08, 0x00, 0x45, 0x00, //TIP
    0x00, 0x3c, 0x04, 0x57, 0x00, 0x00, 0x80, 0x00, 0x98, 0x25, 0x94, 0xcc, 0x39, 0xcb, 0x94, 0xcc, 
    0x3a, 0xe1, 0x08, 0x00, 0x49, 0x5c, 0x03, 0x00, 0x01, 0x00, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 
    0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e, 0x6f, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 
    0x77, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69},
    {
    0x02, 0xff, 0x53, 0xc3, 0xe9, 0xab, 0x00, 0xff, 0x66, 0x7f, 0xd4, 0x3c, 0x08, 0x00, 0x45, 0x00, //T11
    0x00, 0x30, 0x2c, 0x00, 0x40, 0x00, 0x80, 0x06, 0x4b, 0x74, 0xc0, 0xa8, 0x01, 0x02, 0xc0, 0xa8, 
    0x01, 0x01, 0x04, 0x03, 0x00, 0x15, 0x00, 0x3b, 0xcf, 0x44, 0x00, 0x00, 0x00, 0x00, 0x70, 0x20, 
    0x20, 0x00, 0x0c, 0x34, 0x00, 0x00, 0x02, 0x04, 0x05, 0xb4, 0x01, 0x01, 0x04, 0x02              
    }};

    calcular(T[0]);
    calcular(T[1]);
    calcular(T[2]);

    /*printf("\033[93mMensaje: \033[0m");
    for(unsigned char i=0; i<sizeof(Trama1); i++) {
        printf("%c", Trama[i]);
    }*/
    /*printf("\n");
    printf("\033[92mChecksum 1: \033[0m0x%.4x", checksum(Trama1, 0, sizeof(Trama1)));
    printf("\n");
    printf("\033[92mChecksum 2: \033[0m0x%.4x", checksum(Trama2, 0, sizeof(Trama2)));
    printf("\n");
    printf("\033[92mChecksum 3: \033[0m0x%.4x", checksum(Trama3, 0, sizeof(Trama3)));*/
}

void calcular(unsigned char T[]) {
    //unsigned char IHL = (T[14]&0x0f)*4;
    printf("\033[94m----Trama----\033[0m\n");
    if(!(T[24]|T[25])) {
        printf("\033[92m  Checksum: \033[0m0x%.4x\n", checksum(T, inicio, fin((T[14]&0x0f)*4)));
    } else {
        if(!(checksum(T, inicio, fin((T[14]&0x0f)*4)))) {
            printf("  ACK\n");
        } else {
            printf("  NACK\n");
        }
    }
}

unsigned short int checksum(unsigned char T[], unsigned char begin, unsigned char end) {
    int suma = 0;
    for(unsigned char i=begin; i<end; i+=2) {
        if(i == end-1) {
            T[i+1] = 0;
        }
        suma += T[i]<<8 | T[i+1];
    }
    suma += suma>>16;
    suma = suma&0x0000FFFF;
    return ~suma;
}